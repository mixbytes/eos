language: c
git:
  depth: false
services:
  - docker
before_install:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
cache: ccache
jobs:
  include:
    - stage: build
      script:
        - cp -r $HOME/.ccache .ccache
        - docker build --build-arg registry=mixbytes -t tmp-builder -f Docker/Dockerfile --target builder .
        - docker run --rm -v $HOME/.ccache:/out tmp-builder /bin/bash -c "cp -r /haya/.ccache/* /out"
        - docker build --build-arg registry=mixbytes -t mixbytes/haya:$TRAVIS_BRANCH -f Docker/Dockerfile .
        - docker push mixbytes/haya:$TRAVIS_BRANCH
        - |
          if [ $TRAVIS_BRANCH == "master" ]; then
            docker tag mixbytes/haya:master mixbytes/haya:latest
            docker push mixbytes/haya:latest
          fi
